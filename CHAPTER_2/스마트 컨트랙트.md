# 📝 2. 스마트 컨트랙트 📝

</br>

## 목차

1. [스마트 컨트랙트의 개념](#1-스마트-컨트랙트-개념)
    - [비트코인 트랜잭션 vs 스마트 컨트랙트 트랜잭션](#11-비트코인-트랜잭션과-스마트-컨트랙트-트랜잭션)
    - [기능](#12-스마트-컨트랙트의-기능)
2. [스마트 컨트랙트의 설계](#2-스마트-컨트랙트의-설계)
    - [유스케이스 다이어그램](#21-카운터를-위한-유스-케이스-다이어그램)
    - [설계 원칙 3](#22-데이터-애셋-피어-참여자-역할-규칙-그리고-트랜잭션)
    - [설계 원칙 4](#23-클래스-다이어그램에서-컨트랙트-다이어그램으로)
3. [스마트 컨트랙트 코드](#3스마트-컨트랙트-코드-작성)
    - [솔리디티 언어란 ?](#31-솔리디티-언어)
    - [코드](#32-카운트를-위한-스마트-컨트랙트-코드)

</br>

### 🔎 목표

- 스마트 컨트랙트 이해하기
- 스마트 컨트랙트 개발을 위한 설계 원칙 적용하기
- 솔리디티 언어를 사용해 컨트랙트 코딩하기
- 리믹스 IDE를 사용해 스마트 컨트랙트를 작동시키고 트랜잭션을 처리해 보기
- 두 가지 유스 케이스를 위한 스마트 컨트랙트를 설계, 개발, 배포, 테스팅해 보기

</br>

## 용어

- 스마트컨트랙트(smart contract) : 애플리케이션의 규칙과 규정들을 디지털로 정의하고, 검증하고, 검사하며, 강제하기 위한 블록체인에서 작동시킬 수 있는 실행 가능한 코드다. 신뢰할 수 있는 트랜잭션의 수행ㅇ르 지웒나다. 이런 트랜잭션은 추적 기능하고 되돌릴 수 없다.
- [쿼럼(Quorum)](http://wiki.hash.kr/index.php/%EC%BF%BC%EB%9F%BC) : 블록체인 시스템에서 합의를 이루기 위한 최소한의 투표수를 가진 소그룹을 말한다.
- [코다(Corda)](http://wiki.hash.kr/index.php/%EC%BD%94%EB%8B%A4) : 세계 최대의 블록체인 컨소시엄인 R3가 만든 분산원장 기술이다.
- 하이퍼레저 : 스마트 계약을 구현할 수 있는 오픈소스 기반의 프라이빗 블록체인 프로젝트이다. 
- EOA : 외부소유계정(External Owned Account)으로 지갑(CA)보다 상위계정이다. 
- CA : 계약계정(Contract Account)은 스마트컨트랙트 역할 기능을 하며 배포된 코드와 저장공간이 추가로 존재한다. 
- [이더리움 계정과 트랜잭션에 대해](https://jojuim.tistory.com/entry/%EA%B8%B0%EB%B3%B8-%EC%9D%B4%EB%8D%94%EB%A6%AC%EC%9B%80-%EA%B3%84%EC%A0%95%EA%B3%BC-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-CA-EOA-TX-%EB%93%9C)

</br>

## 1. 스마트 컨트랙트 개념

스마트 컨트랙트는 비트코인 블록체인 프로토콜이 제공했던 기본적인 신뢰를 확장시키는 코드이다. 디지털 자산을 위한 트랜잭션을 지원할 수 있는 프로그래밍을 가능하게 해준다. 또한 애플리케이션이 필요로 하는 특정한 확인과 검증을 가능하게 한다.

- 블록체인 애플리케이션 스택과 레이어
<img src="https://user-images.githubusercontent.com/68188768/166471469-f49aba9e-ecf4-4c0e-9b28-951d3da60441.png">
### 1.1 비트코인 트랜잭션과 스마트 컨트랙트 트랜잭션

<img src="https://user-images.githubusercontent.com/68188768/166471983-92ccfce3-9803-4225-b1ee-1cb2371d862b.png">

1. 비트코인
    - 모든 트랜잭션은 가치(Tx(sendValue))를 전송하기 위한 것이다.
    - 오직 암호 화폐의 전송을 위한 트랝개션만을 지원한다.
2. 스마트 컨트랙트
    - 트랜잭션은 스마트 컨트랙트가 구현한 기능을 임베디드한다.
    - 어떠한 애플리케이션 로직도 지원할 수 있다.
    - 예) 투표 애플리케이션을 위한 트랜잭션


이러한 임의적인 코드를 올리고 실행할 수 있는 기능은 암호 화폐 전송을 넘어서서 블록체인의 활용도를 크게 향상시킨다.

### 1.2 스마트 컨트랙트의 기능

스마트 컨트랙트는 블록체인 애플리케이션의 두뇌와 같은 역할을 한다. 주요 기능으로는 다음과 같다.
- 특수한 조건에 맞는 <strong>확인과 검증</strong>을 할 수 있는 비즈니스 로직 레이어를 표현.
- 탈중앙화 네트워크에서 자산의 전송을 위한 <strong>정책</strong>을 구현하기 쉽도록 한다.
- <strong>규칙</strong>의 명세를 설정할 수 있게 한다.
- <strong>함수를 내장</strong>하며 추가적인 <strong>메타 데이터</strong>를 포함한다.
- 탈중앙화 블록체인 기반 애플리케이션을 위한 <strong>소프트웨어 기반 중개자</strong>로서 기능한다.
- 블록체인에 <strong>프로그래밍 기능성과 지능성</strong>을 제공한다.
- 탈중앙화 블록체인 애플리케이션의 중심 컴포넌트이다.

</br>

## 2. 스마트 컨트랙트의 설계

- 설계원칙

1. 테스트 체인에서 스마트 컨트랙트를 코딩, 개발, 배포하기 전에 우선 설계부터 한다. 또한 사마트 컨트랙트는 변조 불가능 하기 때문에 프로덕션 블록체인에 배포하기 전에 철저한 테스트를 거쳐야 한다.
2. 시스템 사용자와 유스 케이스를 정의한다. 사용자란 행위와 입력값을 발생시키고, 설계하고 있는 해당 시스템으로부터 그 출력값으로 받는 주체다.
3. 데이터 애셋, 피어 참여자, 그들의 역할, 강제할 규칙, 설계하고 있는 시스템에 기록해야 할 트랜잭션을 정의한다.
4. 컨트랙트 이름, 데이터 애셋, 함수, 함수의 실행과 데이터 접근을 위한 규칙을 정의하는 컨트랙트 다이어그램을 작성한다.

설계원칙과 관련된 내용을 예제를 이용해서 자세히 다뤄보도록 한다.

<strong> 예제 1) 탈중앙화 카운터 </strong>

탈중앙화 카운터는 일상 애플리케이션에서 공통으로 사용한다.
- 예)

|시스템 타입|카운터 예|
|:---|:---|
|수동시스템|놀이공원의 입출입자 집계를 윟나 회전식 개찰구|
|중앙화 시스템|주식 인덱스|
|분산 시스템|국가 무역 적자|
|탈중앙화 시스템|세계 인구|

트랜잭션을 통해 스마트 컨트랙트를 블록체인에 배포하는데, 블록의 일부분에 포함됨으로써 블록체인에 영구히 기록되고, 되돌릴 수 없으며, 수정할 수 없다.

### 2.1 카운터를 위한 유스 케이스 다이어그램

유스 케이스와 클래스 다이어그램을 보여주기 위해 표준적인 통합 모델 언어[UML](https://www.uml.org/index.html)를 사용한다. UML을 이용하게 되면 해결해야 할 문제와 함수들을 어떻게 사용해야 할지에 대해 숙고할 수 있도록 해준다.

- 카운터를 위한 유스 케이스

<img src="https://user-images.githubusercontent.com/68188768/166472358-05af9910-3b5a-4452-93f0-f4513131e83d.png">

- initialize() : 값에 대한 초기화
- increment() : 주어진 값만큼 증가
- decrement() : 주어진 값만큼 감소
- get() : 카운터값을 가져오기

이 단계에서 만든 설계 내용이 해결해야 하는 문제에는 종속적이지만, 특정한 코딩 또는 시스템에는 종속적이지 않다.

### 2.2 데이터 애셋, 피어 참여자, 역할, 규칙, 그리고 트랜잭션

유스 케이스 다이어그램에서 정의한 함수들을 사용할 주체와 그 규칙이 무엇인지를 정해야 한다. 블록체인 기반 컴포넌트들의 여러 속성에 대해 설명할 것이다.

탈중앙화 카운터 문제에서 설계 원칙 3을 적용하면 다음과 같은 아이템을 설정할 수 있다. 

- 추적해야 할 데이터 애셋 : 카운터의 값
- 피어 참여자 : 카운터 값을 업데이트 할 애플리케이션
- 참여자의 역할 : 카운터값을 업데이트하고 그 값에액세스하는 것
- <i>데이터와 함수에 검증, 검사해야 할 규칙 (현재 예제 유스케이스에는 없음)</i>
- 디지털 정부에 기록해야 하는 트랜잭션 : initialize(), increment(), decrement()

즉, 카운터값을 바꾸는 함수나 트랜잭션만을 기록하면 된다. 스마트 컨트랙트에 정의된 모든 함수가 블록체인의 분산 정부에 기록을 남기는 트랜잭션을 생성하는 것은 아니다. 현재 예제에서 get() 함수는 <strong>읽기 전용 함수로 정의할 수 있다. 읽기 전용 함수의 실행은 블록체인에 기록하지 않는다.</strong>

### 2.3 클래스 다이어그램에서 컨트랙트 다이어그램으로

유스 케이스와 디지털 애셋 분석에서 나온 아이템들을 바탕으로 클래스 다이어그램을 그린다. <strong>OOP의 전형적인 UML 클래스 다이어그램은 클래스의 이름, 데이터 정의, 함수 정의 세 가지 요소를 포함한다.</strong>

- 클래스 다이어그램과 컨트랙트 다이어그램 템플릿 비교

<img src="https://user-images.githubusercontent.com/68188768/166474543-07b52aa0-9864-4a8b-872b-358b8439d152.png">

스마트 컨트랙트 다이어그램은 함수와 데이터에 대한 접근 규칙 컴포넌트를 추가적으로 가지고 있다.

- 카운터 컨트랙트 다이어그램

<img src="https://user-images.githubusercontent.com/68188768/166480780-a56a1183-42b6-4a3f-82d4-8af0fd8208a5.png">

이 다이어그램에서 컨트랙트의 여러 가지 요소(데이터 변수와 함수)의 구분자로 캠러 케이스 양식을 사용했다. constructor()함수는 스마트 컨트랙트가 블록체인 인프라에서 작동하는 VM 샌드박스에 처음 배포되었을 때 한 번만 작동한다. 일반 객체지향 클래스 설계와 크게 다르지 않다. [diagrams.net](https://www.diagrams.net)을 사용해서 그리거나 익숙한 다른 UML을 사용하면 된다.

</br>

## 3. 스마트 컨트랙트 코드 작성

스마트 컨트랙트 개발을 위해서는 블록체인 오퍼레이션에 특화된 전용언어가 필요하다.예제는 솔리디티를 사용하도록 한다. 솔리디티는 이더리움 재단이 처음 도입했는데, 하이퍼레저와 같은 다른 블록체인 플랫폼도 이를 사용한다.

컨ㅌ느랙트 코드를 작성하는 것은 블록체인 기반의 기록을 위해 정밀한 명령을 만드는 것이다. 다만 어카운트 주소, 규칙 사용, 트랜잭션 되돌림과 같은 블록체인에 특화된 특정 기능이 언어에 내장되어 있어야 한다. 또한, 스마트 컨트랙트 코드는 여러 블록체인 코드에서 실행될 때 일관성을 유지하기 위해 제한된 샌드박스 환경에서 실행된다. 

### 3.1 솔리디티 언어

솔리디티 언어는 고수준 언어로 C++, 파이썬, 자바스크립트 등의 영향을 받았다. 정접 타입 언어이며 상속, 라이브러리, 사용자 정의 타입 등을 지원한다. 

### 3.2 카운트를 위한 스마트 컨트랙트 코드

- 리믹스 IDE 사용

1. 브라우저에서 리믹스 IDE를 오픈한다. [바로가기](https://remix.ethereum.org/)
2. 솔리디티 언어를 선택한다(바이퍼는 스마트 컨트랙트를 위한 또 하나의 언어이다.)
3. IDE에서 왼쪽 패널 맨 위에 있는 아이콘을 클릭해서 새 파일을 만든다.
4. 열른 팝업 윈도우에서 Counter.sol이라고 이름을 설정한다.
5. 코드를 작성한다.

- 코드작성

```
pragma solidity ^0.6.0; // 사용한 언어의 버전을 지정 필수
contract Counter {
    uint value; // 카운터값을 위한 공유 데이터
    function initialize (uint x) public {
        value = x;
    }
    
    function get() view public returns (uint) {
        return value;
    }

    function increment (uint n) public {
        value = vlaue + n;
        // return (optional)
    }

    function decrement (uint n) public {
        value = value - n;
    }
}
```

- prama solidity ^<u>version</u> : 사용한 언어의 버전과 컴파일할 때 사용할 버전을 일치시키기 위해서 버전을 지정한다.
- parama 지시문을 사용하며 0.6.0 버전ㅇ르 사용했다.
- 지시문 이후 contract 키워드와 컨트랙트의 이름으로 컨트랙트 코드 정의를 한다.
- 버전을 변경하게 된다면 일부 코드 수정이 필요할 수도 있게된다.
- uint : 데이터 타입을 카운터 값ㅇ르 지정하는 식별자를 정의하기 위해 사용. 솔리디티의 경우 64비트가 아닌 256비트 값이다.
- uint, int, int256, uint256은 모두 같은 값의 별칭이다.
- 명시적인 생성자 함수를 정의하고 있지 않을 때는 기본 생성자가 컨트랙트를 배포하기 위해 사용한다.
- public : 공개적 가시성을 가진다. 즉, 블록체인상에 있는 어떠한 외부의 참여자(또는 어카운트)도 이 함수를 호출할 수 있다는 것을 의미한다.
- return : 함수 호출의 결과로 반환될 값을 명시적으로 정의할 수 있다.
- get() 함수를 제외한 함수들은 본문 안에서 변수 value를 갱신하는 역할을 하며 자동적으로 value의 상태 변화 또는 모두 각각 분산 장부상의 트랜잭션으로 기록된다.
- view : 블록체인상에 기록되지 않으며 카운터 값 상태를 변화시키지 않는다.

</br>

## 4. 스카트 컨트랙트 코드 배포 및 테스트

### 4.1 리믹스 IDE

리믹스는 별도의 설치 과정 없이 웹/클라우드 기반으로 통합 개발 환경을 제공한다. 그뿐만 아니라 자바스크립트 기반의 테스트 체인 환경을 제공하고, 작성한 컨트랙트 코드를 이 체인 윙 ㅔ바로 배포해서 생성할 수 있도록 지원해준다. 이 일체형의 개발 환경에서 테스트한 스마트 컨트랙트 코드는 리믹스 테스트 체인뿐만 아니라 외부 블록체인으로도 쉽게 배포할 수 있다. 

### 4.2 배포와 테스팅

- 배포

1. 컴파일

<img src="https://user-images.githubusercontent.com/68188768/166491663-0e4ebfdf-b85e-4f59-8a6c-e2096d91b5fe.png">

    - 작성한 버전에 맞춰서 컴파일 할 버전을 선택한다.
    - 자동 컴파일 체크하면 이 단계를 진행하지 않을 수 있다.
    - 컴파일 버튼을 클릭한다.

2. 배포 및 트랜잭션 실행 환경 체크

<img src="https://user-images.githubusercontent.com/68188768/166492349-98effbf9-f81b-4df3-8806-d86fc42cfe18.png">

    - 자바스크립트 VM으로 설정되어 있는지 확인

3. 배포

<img src="https://user-images.githubusercontent.com/68188768/166493063-8e0690a2-7034-48f1-a130-06f9dfe90879.png">

    - 배포버튼을 클릭한다. 이후 Deployed Contracts에서 작동을 관찰한다.

- 테스팅 결과

<img src="https://user-images.githubusercontent.com/68188768/166491131-ecfa1c5c-9573-48ed-a5a3-b36428a2a7c0.png">