# 온체인과 오프체인 데이터

</br>

## 목표
- 블록, 트랜잭션, 리시트, 스테이트 같은 여러 종류의 온체인 데이터에 대해 안다.
- 이벤트를 정의, 발생시키고 로그인할 줄 안다.
- Dapp 오퍼레이션을 지원하기 위한 트랜잭션 리스트로부터 이벤트 로그 접근할 수 있다.
- 온체인과 오프체인 데이터를 가진 Dapp설계하고 개발한다.
- ASK와 블라인드 경매 Dapp을 사용해 온체인과 오프체인 데이터를 시연할 수 있다.

</br>

---

</br>

Dapp에서 사용하는 데이터를 어디에 저장하고 있을까? 일부분은 블록체인 인프라(온체인)에 저장하고, 다른 것은 전통적인 데이터베이스와 파일(오프체인)에 저장한다. 일반적으로 블록체인상에 저장하는 모든 데이터는 온체인 데이터이고, 그 이외의 것은 오프체인데이터이다. 

블록체인 노드상에 저장하는 데이터
- 실행하고 컨펌받은 트랜잭션
- 스마트 컨트랙트 함수의 실행 겨로가
- 상태 변화(storage 변숫값에 일어난 변화)
- 발생시킨 이벤트 로그

이러한 데이터를 저장하고, 블록체인 프로토콜에서 설정한대로 다른 참여 노드로 전파한다.

-> <b>온체인 데이터(on-chain data)는</b> 블록체인 기반 애플리케이션이 구동한 트랜잭션이 생성한 정보와 블록체인의 구축(materialization)에 쓰인 아이템의 집합니다.

#### * 전통적인 애플리케이션과 온체인과 오프체인 데이터를 가진 블록체인 Dapp 비교

![image](https://user-images.githubusercontent.com/68188768/168093038-9fa36b6d-1030-4056-b609-9f8684b4c74b.png)
*왼쪽 부분은 통상적인 데이터 저장공간을 나타내고, 오른쪽 부분은 이 시스템에서 온체인 ㄴ데이터를 저장하는 블록체인을 추가해서 개선한 그림이다.*

일반적으로 컨트랙트 파트에서 생성한 데이터는 온체인에 저장하고, 앱 파트에서 생성하고 사용하는 데이터는 오프체인에 저장한다. Dapp의 함수 호출로 스마트 컨트랙트를 구동하여 Txs를 생성하면, 관련된 아티팩트는 블록체인에 기록된다.

</br>

## 1. 온체인 데이터

블록체인 프로토콜은 다음과 같은 여러 종류의 온체인 데이터로 구성된다.

![image](https://user-images.githubusercontent.com/68188768/168095834-f9e78356-bf4f-4755-97e5-15e920636603.png)

- 블록체인 헤더(6A)는 블록의 속성을 저장한다.
- 트랝개션(6B)은 블록에 저장된 Tx의 내용을 저장한다.
- 리시트(6C)는 블록에 기록된 Tx의 실행 결과를 저장한다. 모든 트랜잭션은 리시트를 가지고 있고, 그림과 같은 일대일 관계를 보여준다.
- 총합 글로벌 스테이트(6D)는 모든 블록체인상의 스마트 컨트랙트와 다른 일반 어카운트의 데이터 값 또는 현재 스테이트를 저장하고, 이것을 이용하는 Tx를 컴펌할 때 갱신한다.

아이템 6A가 아이템 6B, 6C, 6D의 해시를 포함(저장)한다. 이러한 아이템들의 해시가 현재 블록의 해시가된다. 현재 블록의 해시는 체인에 추가되는 다음 블록 해시를 구성하는 부분으로 저장된다. 이렇게 해서 블록의 해시가 그 다음(새로 추가되는) 블록의 일부가 됨으로써, 블록은 체인 링크를 형성한다.

</br>

## 2. 블라인드 경매 유스 케이스

블록체인 기반 애플리케이션을 설계할 때 이러한 제약을 잘 인지하고 있어야 한다. 블라인드 경매 유스케이스에서는 그중 리시트 트리에 있는 이벤트 로그에 초점을 맞추어 알아본다.

### 2.1 온체인 이벤트 데이터

이벤트는 스마트 컨트랙트 함수의 실행에서 어떤 조건이나 플래그가 발생했다는 것을 알리기 위해 함수에서 발생시키는 알림이다. 이벤트를 사용하기 전, 스마트 컨트랙트에 미리 정의해 놓는다. 스마트 컨트랙트에서 타입과 변수 선언 바로 뒤에 이벤트를 정의한다. 파라미터 수 자체는 제한이 없으나 인덱스 옵션을 달 수 있는 파라미터는 세 개까지로 제한한다.
- 이벤트 정의
~~~
event NameOfEvent (parameters);
~~~

- 블라인드 경매 컨트랙트에서 사용한 이벤트 예

~~~
event AuctionEnded(address winner, uint highestBid);
~~~

필요한 파라미터 값을 넣어서 이벤트 이름을 호출함으로써 이벤트를 발생시킨다. 
- AuctionEnded이벤트를 발생시키는 예

~~~
emit AuctionEnded(highestBidder, highestBid);
~~~

- 파리머타가 없는 이벤트 정의 예
~~~
evnet BiddingStarted();
event RevealStarted();
~~~

- emit 호출로 이벤트 발생 예
~~~
emit BiddingStarted();
emit RevealStarted();
~~~

### 2.2 이벤트를 가진 블라인드 경매

온체인 데이터에서 이벤트는 블록의 리시트 트리에 기록하는 전형적인 온체인 데이터이다. 이벤트를 호출하면 로그를 발생시키는데, 이로그에 온체인 인덱스를 걸고 토픽으로 조회할 수 있다. 이 경우 이벤트 이름 자체와 파라미터들을 토픽으로 사용할 수 있다. 

- 이벤트 정의를 포함한 블라인드 경매 컨트랙트 다이어 그램
![image](https://user-images.githubusercontent.com/68188768/168420187-e867f2c2-8f90-4a9c-baee-6a6de8e49803.png)

~~~
경매의 종료를 알리는 AuctionEnded
경매의 Bidding 단계를 알리는 BiddingStarted
경매의 Reveal 단계를 알리는 RevealStarted
~~~

5장에서의 changeState)() 함수 대신에 advancePhase() 함수를 사용한다.
~~~
function changeState(Phase x) public onlyBeneficiary {
    if (x < state) revert();
        state = x;
}
~~~
수혜자가 명시적으로, 그리고 직선적으로 상태값을 진전시키는 한 잘 작동하지만, 오직 한 번만 사용할 수 있다. 스마트 컨트랙트를 배포하면 블록체인의 변조 부가성 요구 사항으로 인해 덮어쓰기가 안되기 때문에 큰 문제가 될 수 있다.


BindAuction.sol의 경우 Init, Bidding, Reveal, Done 단계 이후에 다시 다음 경매를 위해 Init 상태로 순환시켜 이전 버전의 문제를 해결한다.

블록체인 기반 시스템을 설계할 때 스마트 컨트랙트의 변조 불가능성 특성을 잘 파악하고 있어야 한다. 스마트 컨트랙트를 장기 실행 프로그램으로 간주하고 적절한 스테이트 사용을 통해 반복적인 실행을 위한 규정을 설정하는 것이 중요하다.


### 2.3 웹 UI를 가진 테스팅

![image](https://user-images.githubusercontent.com/68188768/168421795-c454111e-e3cc-433b-96b3-224ed272b4fb.png)

### 트러플을 사용해 컴파일링하고 배포하기

~~~
1. 테스트 체인 시작
    - 개발 머신에 있는 가니쉬 아이콘을 클릭 후 실행하고 QUICKSTART  
2. 스마트 컨트랙트를 컴파일하고 배포
    - cd blinedauction-contract
    - truffle migrate --reste
3. 웹 서버(Node.js)와 Dapp 웹 컴포넌트 시작
    - cd ../blindauction-app
    - npm install
    - npm start
4. 메타 마스크가 설치된 웹 브라우저(크롬)을 시작.
    - localhost:3000 접속
~~~

- localhost:3000 페이지
<img width="489" alt="스크린샷 2022-05-14 오후 8 20 34" src="https://user-images.githubusercontent.com/68188768/168423522-b0c94dd8-09a1-4219-ad79-e08a6f917426.png">

Account 1, 2, 3을 초기화 한 후 시작하는 것이 좋다. Account 1은 수혜자용이고, 다른 두 개는 입찰자용이다.

=> 웹 페이지에서 Advance phase 버튼이 보이지 않아서 테스팅 X

